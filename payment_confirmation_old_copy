<?php

  ini_set('display_errors', 1);
  ini_set('display_startup_errors', 1);
  error_reporting(E_ALL);
  session_start();

  if (!(isset($_SESSION['app_login']) && $_SESSION['app_login'] != '')) {

  header ("Location: signin.php");

  }

  $studentData = $_SESSION['studentData'];



      $page_title = "Payment Confirmation";
      // Core
      require_once("core/config.php");
      // Header
      require_once("includes/header.php");
      // Navigation
      require_once("nav/nav_login.php");

      require_once("includes/funaabWS.php");
      require_once("includes/ws_functions.php");
      require_once("includes/ws_parameters.php");


  //-------------- flag and message variables declared and initialized -------------------------------
      $err_flag = 0;
      $err_msg = null;
      $message = "";
      $info = '';


  // ------------ get currently active session -------------------------------------------------------

      $academic_session = new AcademicSession();
      $get_active_session = $academic_session->get_active_session();

      $current_academic_session = $get_active_session->fetch(PDO::FETCH_ASSOC);
      $current_academic_session = $current_academic_session['session'];


  //------------------ Check if login credential has been created and sent to user -------- ---------


  $auth = new Auth();
  $is_auth = $auth->is_auth_created($_SESSION['regNumber']);

  // if auth does not exist, create and send user email...
  if (!$is_auth->rowCount()){

        $verification_code = $auth->generate_verification_code();
        $password = $auth->generate_password();
        $password_encrypt = sha1(md5(sha1($password)));
        $user_type = 1;

        $authData = array("username"=>$_SESSION['regNumber'], "password"=>$password_encrypt,"user_type"=>$user_type,"role"=>'',
                      "verification_code"=>$verification_code);

        // create auth record for the user
        $result = $auth->create_auth($authData);

    //check if record creation is Successful
    if ($result->rowCount()){
        // send mail
        $sender = "SIWES";
        $subject = "FUNAAB SIWES Registration";
        $sender_email = 'FUNAAB SIWES siwes@siwes.unaab.edu.ng';
        $recipient = $_SESSION['studentData']['email'];
        $send_message = 'Dear '.$_SESSION['studentData']['surname'].' '.$_SESSION['studentData']['firstname'].',<br/><br/>';
        $send_message .= 'Please find below your login credentials to access the SIWES portal to complete your registration. To use the login credentials
                        you have to activate your account by clicking the link below.<br/><br/>';
        $send_message .= 'Username: '.$_SESSION['regNumber'].'<br/>';
        $send_message .= 'Password: '.$password.'<br/><br/>';

        $send_message .= "http://siwes.unaab.edu.ng/activate_my_account.php?q={$verification_code}&reg=".$_SESSION['regNumber'];


        $mail = new Mail();
        $sent_response = $mail->sendMail($sender, $sender_email, $recipient, $subject, $send_message);

        if ($sent_response=='sent'){
          $message = "An email has been sent to you containing your login credentials";

        }else{
          $err_flag = 1;
          $message = "An error occurred sending your login credentials. Please try again.";
        }

    }else{
      $err_flag = 1;
      $message = "An error occurred creating your login credentials. Please contact the SIWES Office.";
    }





  }else{
    // Record is found
      $message = "Your login credentials has been generated and sent to your email. Resend email";
  }

  //echo $_SESSION['studentData']['email'];






 ?>

<div class="container-fluid">


    <div class="row d-flex justify-content-center" style="margin-top:20px;">





      <!-- left pane //-->
      <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8 mt-5">
          <h4 class='mb-4'>SIWES Registration<br><small>2019/2020 Academic Session</small></h4>

          <hr>

            <!-- Notification Bar //-->
            <?php
                //---------------------------- Info Notification Section ---------------------------------------
                if ($err_flag=1){
                ?>
                  <div class="alert alert-warning" role="alert">
                       <i class="fas fa-info-circle"></i>  <?php echo $message; ?>
                  </div>

                <?php
                }
                // ---------------------------- End of Info Notification Section -------------------------------

                //---------------------------- Error Message Notification Section ---------------------------------------
                if ($err_flag=''){
                ?>
                  <div class="alert alert-danger" role="alert">
                       <i class="fas fa-exclamation-circle"></i>  <?php echo $message; ?>
                  </div>

                <?php
                }
                // ---------------------------- End of Error Message Notification Section
            ?>
            <!-- end of Notification Bar //-->


      </div><!-- end of columm //-->
      <!-- end of right column //-->



    </div><!-- end of row //-->



</div><!-- end of container //-->

<br/><br/>
<?php
      //footer
      require_once("includes/footer.php");
 ?>
